---
title: "How to add role claims to an Azure B2C user flow access token"
description: ""
date: "2023-01-23"
draft: false
slug: "add-role-claims-to-an-azure-b2c-user-flow-access-token"
tags:
---

<p><em>I've built an </em><a href="https://github.com/clintmcmahon/azure-ad-b2c-user-manager" rel="noreferrer"><em>entire Azure AD B2C User Management solution</em></a><em> that is available for free on Github. The code samples below are part of this larger solution. Feel free to use this application as you see fit. </em><a href="__GHOST_URL__/contact" rel="noreferrer"><em>Contact me</em></a><em> if you run into any issues or need help consulting on your Azure AD B2C project.</em></p><p>This post is about how to add custom role claims to an Azure B2C user flow access token without a custom policy. Azure B2C comes with a standard set of <a href="https://learn.microsoft.com/en-us/azure/active-directory-b2c/user-profile-attributes">built-in attributes</a> like City, Display Name and Street Address but you also have the ability to add your own custom attributes. When configured as application claims these attributes can be returned to the calling application via the access token after the user has authenticated.</p><p>Unfortunately, B2C does not have a built in attribute for roles or role based security. There is the ability to add roles as claims using custom policies as well, but this post is about how to add a custom role claim to an Azure B2C user flow access token without the need for a custom policy.</p><h2 id="add-a-custom-attribute">Add a custom attribute</h2><p>First thing you need to do is create a custom attribute and add it to the application claims in your sign in user flow. </p><ol><li>Go to your Azure AD B2C tenant</li><li>Under <strong>Manage</strong>, select User attributes then <strong>Add</strong></li><li>Give your attribute the name <strong>Roles</strong> and a description. Then click <strong>Create</strong>.</li></ol><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/images/2023/04/Screenshot-2023-04-11-at-9.39.41-AM-1.png" class="kg-image" alt="" loading="lazy" width="1257" height="575" srcset="/images/size/w600/2023/04/Screenshot-2023-04-11-at-9.39.41-AM-1.png 600w, /images/size/w1000/2023/04/Screenshot-2023-04-11-at-9.39.41-AM-1.png 1000w, /images/2023/04/Screenshot-2023-04-11-at-9.39.41-AM-1.png 1257w" sizes="(min-width: 720px) 720px"><figcaption><span style="white-space: pre-wrap;">Custom Roles attribute</span></figcaption></figure><h2 id="add-the-new-roles-attribute-to-application-claims">Add the new Roles attribute to application claims</h2><p>In this step you add the newly created Roles attribute to the application claims that are returned in the access token. The access token is created and returned to the calling application after the user has been successfully authenticated. This is assuming you already have a Sign in user flow created. If you do not have a Sign in user flow created then <a href="https://learn.microsoft.com/en-us/azure/active-directory-b2c/tutorial-create-user-flows">go here to create the user flow</a>. </p><ol><li>Under <strong>Policies</strong>, select <strong>User flows</strong> then your <strong>Sign in User flow</strong></li><li>Under <strong>Settings</strong>, select <strong>Application claims</strong></li><li>These are the different claims that are returned via the access code after the user has authenticated. You can select whatever claims here that are available, but select the Roles claim if nothing else.</li><li>After you check the boxes next to the claims you want returned, click <strong>Save</strong>.</li></ol><figure class="kg-card kg-image-card"><img src="/images/2023/04/Screenshot-2023-04-11-at-9.47.43-AM.png" class="kg-image" alt="" loading="lazy" width="1274" height="669" srcset="/images/size/w600/2023/04/Screenshot-2023-04-11-at-9.47.43-AM.png 600w, /images/size/w1000/2023/04/Screenshot-2023-04-11-at-9.47.43-AM.png 1000w, /images/2023/04/Screenshot-2023-04-11-at-9.47.43-AM.png 1274w" sizes="(min-width: 720px) 720px"></figure><h2 id="populate-roles-claim-with-the-graph-api">Populate Roles claim with the Graph API</h2><p>Unfortunately, there is no way to update a B2C custom claim in the Azure portal, you'll need to populate the value via the Graph API. <a href="__GHOST_URL__/how-to-use-graph-api-to-query-azure-ad-b2c-users-using-postman/">Follow this blog post</a> if you do not already have a working implementation of the Graph API. </p><p>To set the new Roles claim value for a user, send a PATCH request to the <a href="https://graph.microsoft.com/v1.0/users/{{user id}}">https://graph.microsoft.com/v1.0/users/{{user id}}</a> endpoint with the value for new Roles extension. The <strong>user id</strong> property is also referred to as the <strong>ObjectId</strong> of the user. </p><p>The the format of custom attributes, which are also referred to as extensions, is as follows: <strong>“extension_{{B2C Extension App Id}}_{Name of the extension}”</strong>. The value for B2C Extension App Id refers to the special app that is automatically registered within your B2C tenant to keep track of all the attributes. To find the B2C Extenstion App Id follow these steps:</p><ol><li>In your B2C tenant under <strong>Manage</strong> select <strong>App registrations</strong></li><li>Select <strong>All applications</strong></li><li>Not there will be an application named <strong>b2c-extensions-app. Do not modify. Used by AADB2C for storing user data.</strong> </li><li>Copy the <strong>Application (client) ID </strong>and use it in the PATCH request.</li></ol><p>Here is an example of what the request should look like. Here I'm setting the value of <strong>Roles</strong> to <strong>Admin</strong>.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/images/2023/04/image.png" class="kg-image" alt="" loading="lazy" width="631" height="433" srcset="/images/size/w600/2023/04/image.png 600w, /images/2023/04/image.png 631w"><figcaption><span style="white-space: pre-wrap;">Example PATCH request for B2C custom role</span></figcaption></figure><h2 id="view-the-new-role-claim-in-the-access-token">View the new role claim in the access token</h2><p>The final step is to run the User flow to see your new <strong>Roles </strong>claim in the returned access token. </p><ol><li>Go to your B2C tenant and select <strong>User flows</strong> under <strong>Policies</strong>. </li><li>Select the <strong>Sign in</strong> User flow and run. My user flow has the return url value of https://jwt.ms to decode the access token. </li><li>After you have successfully authenticated and viewed the access token you should now see the newly created role claim <strong>extension_Roles</strong> with the value of <strong>Admin</strong>. All extension attributes start with <strong>extension_</strong> as default. </li><li>Keep in mind that custom attribute extensions do not show up as Application claims for users who have not had the value applied to their account. Running the user flow with a user who has not had the <strong>extension_Roles</strong> value applied will return an access token that does not contain <strong>extension_Roles</strong> claim.</li></ol><figure class="kg-card kg-image-card kg-card-hascaption"><img src="/images/2023/04/image-2.png" class="kg-image" alt="" loading="lazy" width="925" height="473" srcset="/images/size/w600/2023/04/image-2.png 600w, /images/2023/04/image-2.png 925w" sizes="(min-width: 720px) 720px"><figcaption><span style="white-space: pre-wrap;">S</span></figcaption></figure><p>Now you can inspect the access token in your app to check the user roles. </p>
